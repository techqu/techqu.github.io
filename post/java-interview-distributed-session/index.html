<!DOCTYPE html>
<html class="no-js" lang="en-us">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Java面试-分布式会话 - Mainroad</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<meta property="og:title" content="Java面试-分布式会话" />
<meta property="og:description" content="1、面试题

集群部署时的分布式session如何实现？" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/post/java-interview-distributed-session/" />
<meta property="article:published_time" content="2019-05-21T17:55:57+08:00" />
<meta property="article:modified_time" content="2019-05-21T17:55:57+08:00" />

	<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Java面试-分布式会话"/>
<meta name="twitter:description" content="1、面试题

集群部署时的分布式session如何实现？"/>

	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">
	<link rel="stylesheet" href="/css/style.css">
	<link rel="stylesheet" href="/css/syntax.css"><link rel="stylesheet" href="/css/douban.css">
	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container">
		<div class="logo">
			<a class="logo__link" href="/" title="Mainroad" rel="home">
				<div class="logo__title">Mainroad</div>
				<div class="logo__tagline">Just another site</div>
			</a>
		</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Java面试-分布式会话</h1>
			<div class="post__meta meta">
<div class="meta__item-datetime meta__item">
	<svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg>
	<time class="meta__text" datetime="2019-05-21T17:55:57">May 21, 2019</time>
</div>
</div>
		</header>
<div class="post__toc toc">
	<div class="toc__title">Page content</div>
	<div class="toc__menu">
		<nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#1-面试题">1、面试题</a></li>
<li><a href="#2-面试官心里分析">2、面试官心里分析</a></li>
<li><a href="#3-面试题剖析">3、面试题剖析</a>
<ul>
<li><a href="#1-tomcat-redis">（1）tomcat + redis</a></li>
<li><a href="#2-spring-session-redis">（2）spring session + redis</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
	</div>
</div>
<div class="content post__content clearfix">
			<h2 id="1-面试题">1、面试题</h2>

<p>集群部署时的分布式session如何实现？</p>

<h2 id="2-面试官心里分析">2、面试官心里分析</h2>

<p>面试官问了你一堆dubbo是怎么玩儿的，你会玩儿dubbo就可以把单块系统弄成分布式系统，然后分布式之后接踵而来的就是一堆问题，最大的问题就是分布式事务、接口幂等性、分布式锁，还有最后一个就是分布式session。</p>

<p>当然了，分布式系统中的问题何止这么一点，非常之多，复杂度很高，但是这里就是说下常见的几个，也是面试的时候常问的几个。</p>

<h2 id="3-面试题剖析">3、面试题剖析</h2>

<p><img src="/img/01_分布式会话是什么.png" alt="01_分布式会话是什么" /></p>

<p>session是啥？浏览器有个cookie，在一段时间内这个cookie都存在，然后每次发请求过来都带上一个特殊的jsessionid cookie，就根据这个东西，在服务端可以维护一个对应的session域，里面可以放点儿数据。</p>

<p>一般只要你没关掉浏览器，cookie还在，那么对应的那个session就在，但是cookie没了，session就没了。常见于什么购物车之类的东西，还有登录状态保存之类的。</p>

<p>这个不多说了，懂java的都该知道这个。</p>

<p>但是你单块系统的时候这么玩儿session没问题啊，但是你要是分布式系统了呢，那么多的服务，session状态在哪儿维护啊？</p>

<p>其实方法很多，但是常用的是两种：</p>

<h3 id="1-tomcat-redis">（1）tomcat + redis</h3>

<p>这个其实还挺方便的，就是使用session的代码跟以前一样，还是基于tomcat原生的session支持即可，然后就是用一个叫做Tomcat RedisSessionManager的东西，让所有我们部署的tomcat都将session数据存储到redis即可。</p>

<p>在tomcat的配置文件中，配置一下</p>

<pre><code class="language-xml">&lt;Valve className=&quot;com.orangefunction.tomcat.redissessions.RedisSessionHandlerValve&quot; /&gt;

&lt;Manager className=&quot;com.orangefunction.tomcat.redissessions.RedisSessionManager&quot;
         host=&quot;{redis.host}&quot;
         port=&quot;{redis.port}&quot;
         database=&quot;{redis.dbnum}&quot;
         maxInactiveInterval=&quot;60&quot;/&gt;
</code></pre>

<p>搞一个类似上面的配置即可，你看是不是就是用了RedisSessionManager，然后指定了redis的host和 port就ok了。</p>

<pre><code class="language-xml">&lt;Valve className=&quot;com.orangefunction.tomcat.redissessions.RedisSessionHandlerValve&quot; /&gt;
&lt;Manager className=&quot;com.orangefunction.tomcat.redissessions.RedisSessionManager&quot;
	 sentinelMaster=&quot;mymaster&quot;
	 sentinels=&quot;&lt;sentinel1-ip&gt;:26379,&lt;sentinel2-ip&gt;:26379,&lt;sentinel3-ip&gt;:26379&quot;
	 maxInactiveInterval=&quot;60&quot;/&gt;
</code></pre>

<p>还可以用上面这种方式基于redis哨兵支持的redis高可用集群来保存session数据，都是ok的</p>

<h3 id="2-spring-session-redis">（2）spring session + redis</h3>

<p>分布式会话的这个东西重耦合在tomcat中，如果我要将web容器迁移成jetty，难道你重新把jetty都配置一遍吗？</p>

<p>因为上面那种tomcat + redis的方式好用，但是会严重依赖于web容器，不好将代码移植到其他web容器上去，尤其是你要是换了技术栈咋整？比如换成了spring cloud或者是spring boot之类的。还得好好思忖思忖。</p>

<p>所以现在比较好的还是基于java一站式解决方案，spring了。人家spring基本上包掉了大部分的我们需要使用的框架了，spirng cloud做微服务了，spring boot做脚手架了，所以用sping session是一个很好的选择。</p>

<p>pom.xml</p>

<pre><code class="language-xml">&lt;dependency&gt;
  &lt;groupId&gt;org.springframework.session&lt;/groupId&gt;
  &lt;artifactId&gt;spring-session-data-redis&lt;/artifactId&gt;
  &lt;version&gt;1.2.1.RELEASE&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
  &lt;groupId&gt;redis.clients&lt;/groupId&gt;
  &lt;artifactId&gt;jedis&lt;/artifactId&gt;
  &lt;version&gt;2.8.1&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>

<p>spring配置文件中</p>

<pre><code class="language-xml">&lt;bean id=&quot;redisHttpSessionConfiguration&quot;
     class=&quot;org.springframework.session.data.redis.config.annotation.web.http.RedisHttpSessionConfiguration&quot;&gt;
    &lt;property name=&quot;maxInactiveIntervalInSeconds&quot; value=&quot;600&quot;/&gt;
&lt;/bean&gt;

&lt;bean id=&quot;jedisPoolConfig&quot; class=&quot;redis.clients.jedis.JedisPoolConfig&quot;&gt;
    &lt;property name=&quot;maxTotal&quot; value=&quot;100&quot; /&gt;
    &lt;property name=&quot;maxIdle&quot; value=&quot;10&quot; /&gt;
&lt;/bean&gt;

&lt;bean id=&quot;jedisConnectionFactory&quot;
      class=&quot;org.springframework.data.redis.connection.jedis.JedisConnectionFactory&quot; destroy-method=&quot;destroy&quot;&gt;
    &lt;property name=&quot;hostName&quot; value=&quot;${redis_hostname}&quot;/&gt;
    &lt;property name=&quot;port&quot; value=&quot;${redis_port}&quot;/&gt;
    &lt;property name=&quot;password&quot; value=&quot;${redis_pwd}&quot; /&gt;
    &lt;property name=&quot;timeout&quot; value=&quot;3000&quot;/&gt;
    &lt;property name=&quot;usePool&quot; value=&quot;true&quot;/&gt;
    &lt;property name=&quot;poolConfig&quot; ref=&quot;jedisPoolConfig&quot;/&gt;
&lt;/bean&gt;
</code></pre>

<p>web.xml</p>

<pre><code class="language-xml">&lt;filter&gt;
    &lt;filter-name&gt;springSessionRepositoryFilter&lt;/filter-name&gt;
    &lt;filter-class&gt;org.springframework.web.filter.DelegatingFilterProxy&lt;/filter-class&gt;
&lt;/filter&gt;
&lt;filter-mapping&gt;
    &lt;filter-name&gt;springSessionRepositoryFilter&lt;/filter-name&gt;
    &lt;url-pattern&gt;/*&lt;/url-pattern&gt;
&lt;/filter-mapping&gt;
</code></pre>

<p>示例代码</p>

<pre><code class="language-java">@Controller
@RequestMapping(&quot;/test&quot;)
public class TestController {

@RequestMapping(&quot;/putIntoSession&quot;)
@ResponseBody
    public String putIntoSession(HttpServletRequest request, String username){
        request.getSession().setAttribute(&quot;name&quot;,  “leo”);

        return &quot;ok&quot;;
    }

@RequestMapping(&quot;/getFromSession&quot;)
@ResponseBody
    public String getFromSession(HttpServletRequest request, Model model){
        String name = request.getSession().getAttribute(&quot;name&quot;);
        return name;
    }
}
</code></pre>

<p>上面的代码就是ok的，给sping session配置基于redis来存储session数据，然后配置了一个spring session的过滤器，这样的话，session相关操作都会交给spring session来管了。接着在代码中，就用原生的session操作，就是直接基于spring sesion从redis中获取数据了。</p>

<p>实现分布式的会话，有很多种很多种方式，我说的只不过比较常见的两种方式，tomcat + redis早期比较常用；近些年，重耦合到tomcat中去，通过spring session来实现。</p>
		</div>
	</article>
</main>

<div class="authorbox clearfix">
	<figure class="authorbox__avatar">
		<img alt="me avatar" src="/img/avatar.jpg" class="avatar" height="90" width="90">
	</figure>
	<div class="authorbox__header">
		<span class="authorbox__name">About me</span>
	</div>
	<div class="authorbox__description">
		记录生活的点滴，学习知识，分享知识
	</div>
</div>

<nav class="post-nav flex">
	<div class="post-nav__item post-nav__item--prev">
		<a class="post-nav__link" href="/post/java-interview-distributed-dubbo07/" rel="prev"><span class="post-nav__caption">«&thinsp;Previous</span><p class="post-nav__post-title">Java面试-分布式 分布式服务接口的幂等性和顺序性</p></a>
	</div>
	<div class="post-nav__item post-nav__item--next">
		<a class="post-nav__link" href="/post/introduction-to-ddd-cqrs-and-event/" rel="next"><span class="post-nav__caption">Next&thinsp;»</span><p class="post-nav__post-title">关于 DDD、CQRS和Event Souring</p></a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2019 Mainroad.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
	</div>
<script async defer src="/js/menu.js"></script>
<script src="/js/douban.js"></script></body>
</html>